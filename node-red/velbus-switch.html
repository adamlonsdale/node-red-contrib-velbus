<script type="text/x-red" data-template-name="velbus-switch">

	<div class="form-row">
        <label for="node-input-address"><i class="fa fa-envelope"></i> Address</label>
        <div style="display: inline-block; position: relative; width: 70%; height: 20px;">
            <a id="node-input-scan" class="editor-button" style="position: absolute; left: 0px; top: 0px;">
                <i class="fa fa-search"></i>
            </a>
            <div style="position: absolute; left: 40px; right: 0px;">
                <input id="node-input-address" type="text" style="width:100%">
            </div>
        </div>
    </div>

     <div class="form-row">
        <label for="node-input-channel"><i class="fa fa-dot-circle-o"></i> Channel</label>
        <select id="node-input-channel" type="text" style="width: 70%">
	        <option value="1">Button 1</option>
	        <option value="2">Button 2</option>
	        <option value="3">Button 3</option>
	        <option value="4">Button 4</option>
	        <option value="5">Button 5</option>
	        <option value="6">Button 6</option>
	        <option value="7">Button 7</option>
	        <option value="8">Button 8</option>
        </select>
    </div>

	<div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <div style="display: inline-block; position: relative; width: 70%; height: 20px;">
            <a id="node-input-get-label" class="editor-button"
                style="position: absolute; left: 0px; top: 0px;">
                <i class="fa fa-search"></i>
            </a>
            <div style="position: absolute; left: 40px; right: 0px;">
                <input id="node-input-name" type="text" style="width:100%">
            </div>
        </div>
    </div>








</script>

<script type="text/x-red" data-help-name="velbus-switch">
    <p>Velbus Switch node to send and listen to button events.</p>

    <h3>Setup</h3>
    <p>The velbus serial port is found automatically. You might restart the Node-red service on first deploy.</p>

    <h3>Listening for button events</h3>
    <p>The event message that the Button sends contains the following data in the <b>msg.payload</b>:</p>
    <dl class="message-properties">
        <dt>pressed<span class="property-type">string</span></dt>
        <dd>When the button is pressed.</dd>

        <dt>released<span class="property-type">string</span></dt>
        <dd>When the button is released.</dd>

        <dt>longPressed<span class="property-type">string</span></dt>
        <dd>When the button is pressed more then 2 seconds.</dd>
    </dl>

    <h3>Sending button events</h3>
	<p>You can mimic button events by injecting a message like so:
	<dl class="message-properties">
        <dt>msg.payload="press"<span class="property-type"></span></dt>
        <dd>This mimics a short press (press and release). Recommended and easiest for most scenarios.</dd>

		<dt>msg.payload="pressed"<span class="property-type"></span></dt>
        <dd>This mimics <b>only</b> a press.<br>
            You are supposed to send a <pre>released</pre> command afterwards.
            If you want to mimic a long press (> 2s), see below.</dd>

        <dt>msg.payload="released"<span class="property-type"></span></dt>
        <dd>This mimics an release. Required after a <pre>(long)pressed</pre></dd>

        <dt>msg.payload="longPressed"<span class="property-type"></span></dt>
        <dd>Mimics a long press. This will only work if you first mimic a <pre>pressed</pre> then a <pre>longPressed</pre>,
        and finally a <pre>released</pre></dd>
    </dl>


</script>

<script type="text/javascript">

	RED.nodes.registerType('velbus-switch', {
		category: 'Velbus',
		color: '#e1444e',
		defaults: {
			address: {value: "", required: true},
			channel: {value: "", required: true},
			name: {value: "", required: false}
		},
		inputs: 1,
		outputs: 1,
		//outputLabels: 'button pressed',
		align: 'right',
		icon: "",
		paletteLabel: "Button",
		label: function () {
			if (this.address && this.channel) {
				return this.name || `Button @ ${this.address}, ch ${this.channel}`;
			} else {
				return this.name || 'Button'
			}

		},


		oneditsave: function () {
			console.info("oneditsave switch");
			//$.get('velbus/init-velbus-port');
		},

		oneditprepare: () => {

			function searchAndSelectModule() {

				$.get(`velbus/scan-for-modules`).then(msg => {
					if (msg === "no velbus") {
						RED.notify("Deploy first to connect to Velbus ...", "error");
					} else {
						RED.notify("Scanning for Velbus modules ...", "info");
					}
				});


			}

			function manualSwitchModule() {
				let current = $('#node-input-address').val();
				$('#node-input-address').replaceWith('<input type="text" id="node-input-address" style="width: 100%"/>');
				$('#node-input-address').val(current);
			}

			$("#node-input-scan").click(() => {

				if ($('#node-input-address').prop("tagName") === "INPUT") {
					searchAndSelectModule();
				} else {
					manualSwitchModule();
				}

			});


			$("#node-input-get-label").click(() => {
				const address = $('#node-input-address').val();
				const channel = $('#node-input-channel').val();
				if (address && channel) {
					const url = `velbus/get-name-for-button/${address}/${channel}`;
					console.log("url", url);
					$.get(url).then(msg => {
						if (msg === "no velbus") {
							RED.notify("Deploy first to connect to Velbus ...", "error");
						}
					});
				} else {
					RED.notify("Add an Adress and Channel first.", "error");
				}
			});
		}


	});

	RED.comms.subscribe("onVelbusModuleFound", (key, modules) => {

		let current = $('#node-input-address').val();

		$('#node-input-address').replaceWith('<select id="node-input-address" type="text" style="width: 100%"></select>');

		// RESET OPTIONS
		$('#node-input-address').empty();

		// SET MODULES AS OPTIONS
		modules.forEach(function (module) {
			$('#node-input-address').append(`<option value="${module.address}">${module.name} @ ${module.address}</option>`);
		});

		// SELECT CURRENT VALUE
		$('#node-input-address').val(current);
	});

	RED.comms.subscribe("onVelbusButtonName", (key, value) => $('#node-input-name').val(value));


</script>
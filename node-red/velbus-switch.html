<script type="text/x-red" data-template-name="velbus-switch">
    <div class="form-row">
        <label for="node-input-serial"><i class="fa fa-server"></i> Serial Port</label>
        <input type="text" id="node-input-serial">
    </div>

	<div class="form-row">
        <label for="node-input-address"><i class="fa fa-envelope"></i> Address</label>
        <div style="display: inline-block; position: relative; width: 70%; height: 20px;">
            <a id="node-input-scan" class="editor-button" style="position: absolute; left: 0px; top: 0px;">
                <i class="fa fa-search"></i>
            </a>
            <div style="position: absolute; left: 40px; right: 0px;">
                <input id="node-input-address" type="text" style="width:100%">
            </div>
        </div>
    </div>

     <div class="form-row">
        <label for="node-input-channel"><i class="fa fa-dot-circle-o"></i> Channel</label>
        <select id="node-input-channel" type="text" style="width: 70%">
	        <option value="1">Button 1</option>
	        <option value="2">Button 2</option>
	        <option value="3">Button 3</option>
	        <option value="4">Button 4</option>
	        <option value="5">Button 5</option>
	        <option value="6">Button 6</option>
	        <option value="7">Button 7</option>
	        <option value="8">Button 8</option>
        </select>
    </div>

	<div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <div style="display: inline-block; position: relative; width: 70%; height: 20px;">
            <a id="node-input-get-label" class="editor-button"
                style="position: absolute; left: 0px; top: 0px;">
                <i class="fa fa-search"></i>
            </a>
            <div style="position: absolute; left: 40px; right: 0px;">
                <input id="node-input-name" type="text" style="width:100%">
            </div>
        </div>
    </div>




</script>

<script type="text/x-red" data-help-name="velbus-switch">
    <p>Velbus Switch node to receive button events.</p>

    <h3>Setup</h3>
    <p>Select the Velbus Serial port connected to this machine. The velbus port is found automatically.</p>

    <h3>Button Events</h3>
    <p>The event message that the Button sends contains the following data in the <b>msg.payload</b>:</p>
    <dl class="message-properties">
        <dt>pressed<span class="property-type">string</span></dt>
        <dd>When the button is pressed.</dd>

        <dt>released<span class="property-type">string</span></dt>
        <dd>When the button is released.</dd>

        <dt>longPressed<span class="property-type">string</span></dt>
        <dd>When the button is pressed more then 2 seconds.</dd>
    </dl>
</script>

<script type="text/javascript">

	RED.nodes.registerType('velbus-switch', {
		category: 'Velbus',
		color: '#e1444e',
		defaults: {
			serial: {value: "", type: "velbus-config"},
			address: {value: "", required: false},
			channel: {value: "", required: false},
			name: {value: "", required: false},
		},
		inputs: 0,
		outputs: 1,
		outputLabels: 'button pressed',
		align: 'right',
		icon: "",
		paletteLabel: "Button",
		label: function () {
			return this.name || `Button @ ${this.address}, ch ${this.channel}`;
		},


		// oneditsave: function () {
		// 	console.info("oneditsave switch");
		// 	$.get('velbus/init-velbus-port');
		// },

		oneditprepare: () => {

			//debugger;
			function searchAndSelectModule() {

				let current = $('#node-input-address').val();

				let configNodeId = $('#node-input-serial').val();

				// $.get(`velbus/get-config-velbus-port`)
				// 		.done(result => {
				// 			velbus = result
				// 		});
				//
				//
				// velbusConfigNode = RED.nodes.getNode(configNodeId);
				// const port = velbusConfigNode.serial;
				// let velbus;
				//
				// if (!port) {
				// 	RED.notify("Please select a Serial port first ...", "error")
				// 	return
				// }
				if (configNodeId === "_ADD_") {
					RED.notify("Set and deploy the Serial Port first.", "error");
					return
				}

				$.get(`velbus/get-modules/${configNodeId}`)
						.done(modules => {
							modules = JSON.parse(modules);


							if (modules && modules.length > 0) {

								$('#node-input-address').replaceWith('<select id="node-input-address" type="text" style="width: 100%"></select>');
								$('#node-input-address').append('<option selected="selected" value="null">Searching Velbus modulesâ€¦</option>');

								// RESET OPTIONS
								$('#node-input-address').empty();

								// SET MODULES AS OPTIONS
								modules.forEach(function (module) {
									$('#node-input-address').append(`<option value="${module.address}">${module.name} @ ${module.address}</option>`);
								});

								// SELECT CURRENT VALUE
								$('#node-input-address').val(current);

								//velbus.close();


							} else {
								RED.notify("No Velbus modules found that have buttons", "error");
							}
						});

			}

			function manualSwitchModule() {
				let current = $('#node-input-address').val();
				$('#node-input-address').replaceWith('<input type="text" id="node-input-address" style="width: 100%"/>');
				$('#node-input-address').val(current);
			}

			$("#node-input-scan").click(() => {

				if ($('#node-input-address').prop("tagName") === "INPUT") {
					searchAndSelectModule();
				} else {
					manualSwitchModule();
				}

			});

			$("#node-input-get-label").click(() => {
				$.get(`velbus/get-name-for_module/${configNodeId}`)
						.done(modules => {
							modules = JSON.parse(modules);


						});
			});
		}


	});
</script>